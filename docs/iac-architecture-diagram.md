# インフラ構成図

## 1. 全体概要図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Auth0 (共通認証基盤)                            │
│                    ┌──────────────────────────┐                         │
│                    │  SPA Client (per Cloud)  │                         │
│                    │  Resource Server (API)   │                         │
│                    └──────────────────────────┘                         │
└──────────────────────────────┬──────────────────────────────────────────┘
                               │ JWT (RS256)
                               │
            ┌──────────────────┼──────────────────┐
            │                  │                  │
            ▼                  │                  ▼
   ┌─────────────────┐        │        ┌─────────────────┐
   │      AWS        │        │        │     Azure       │
   │  (ap-northeast-1)│        │        │  (japaneast)    │
   │                 │        │        │                 │
   │  CloudFront     │   ユーザー    │  Front Door     │
   │  S3 + ECS      │        │        │  Storage + App  │
   │  Aurora         │        │        │  PostgreSQL     │
   └─────────────────┘                 └─────────────────┘
```

---

## 2. AWS インフラ構成図

```
                                    ┌───────────┐
                                    │  ユーザー   │
                                    └─────┬─────┘
                                          │ HTTPS
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Amazon CloudFront                                    │
│                                                                                 │
│  ┌─────────────────────────────┐    ┌──────────────────────────────────┐        │
│  │  デフォルトビヘイビア /* 　      │    │  追加ビヘイビア /api/*              │        │
│  │  ・キャッシュ: 有効             │    │  ・キャッシュ: 無効                  │        │
│  │  ・HTTPS リダイレクト           │    │  ・全HTTPメソッド許可               │        │
│  │  ・SPA: 403→200 /index.html  │    │  ・VPC Origin経由                  │        │
│  └──────────────┬──────────────┘    └────────────────┬─────────────────┘        │
│                 │ OAC (SigV4)                        │ VPC Origin               │
└─────────────────┼────────────────────────────────────┼──────────────────────────┘
                  │                                    │
                  ▼                                    │
┌────────────────────────┐                             │
│     Amazon S3          │                             │
│  ┌──────────────────┐  │                             │
│  │ React SPA        │  │                             │
│  │ (静的ファイル)     │  │                             │
│  │ index.html       │  │                             │
│  │ assets/          │  │                             │
│  └──────────────────┘  │                             │
└────────────────────────┘                             │
                                                       │
┌──────────────────────────────────────────────────────┼──────────────────────────┐
│  VPC  172.16.0.0/16                                  │                          │
│                                                      │                          │
│  ┌───────────────────────────────────────────────────┼────────────────────────┐ │
│  │  パブリックサブネット 172.16.1.0/24 (ap-northeast-1a)  │                        │ │
│  │                                                   │                        │ │
│  │  ┌─────────────┐          ┌───────────────┐       │                        │ │
│  │  │  NAT GW     │          │  Bastion      │       │                        │ │
│  │  │  (EIP)      │          │  Host (EC2)   │       │                        │ │
│  │  └──────┬──────┘          └───────┬───────┘       │                        │ │
│  │         │                         │               │                        │ │
│  └─────────┼─────────────────────────┼───────────────┼────────────────────────┘ │
│            │                         │               │                          │
│  ┌─────────┼─────────────────────────┼───────────────┼────────────────────────┐ │
│  │  プライベートサブネット 172.16.2.0/24 (1a) & 172.16.3.0/24 (1c)              │ │
│  │         │                         │               │                        │ │
│  │         │                         │               ▼                        │ │
│  │         │                         │    ┌──────────────────────┐            │ │
│  │         │                         │    │   ALB (内部)          │            │ │
│  │         │                         │    │   [SG: CF VPC Origin] │            │ │
│  │         │                         │    │   Listener: HTTP:80  │            │ │
│  │         │                         │    │   Rule: /api/*       │            │ │
│  │         │                         │    └──────────┬───────────┘            │ │
│  │         │                         │               │ :3000                  │ │
│  │         │                         │               ▼                        │ │
│  │         │                         │    ┌──────────────────────┐            │ │
│  │         │                         │    │  ECS Fargate Cluster │            │ │
│  │         │                         │    │  ┌────────────────┐  │            │ │
│  │         │                         │    │  │ Task           │  │            │ │
│  │         │                         │    │  │ CPU: 256       │  │            │ │
│  │         │                         │    │  │ Mem: 512MB     │  │            │ │
│  │         │                         │    │  │ [SG: ALB→3000] │  │            │ │
│  │         │                         │    │  │                │  │            │ │
│  │         │                         │    │  │  NestJS API    │  │            │ │
│  │         │                         │    │  │  (Docker/ECR)  │  │            │ │
│  │         │                         │    │  └───────┬────────┘  │            │ │
│  │         │                         │    └──────────┼───────────┘            │ │
│  │         │                         │               │ :5432                  │ │
│  │         │                         │               ▼                        │ │
│  │         │                         │    ┌──────────────────────┐            │ │
│  │         │                         └───>│ Aurora Serverless v2 │            │ │
│  │         │                              │ PostgreSQL 16.6     │            │ │
│  │         │                              │ 0.0-1.0 ACU         │            │ │
│  │         │                              │ [SG: ECS+Bastion    │            │ │
│  │         │                              │      →5432]         │            │ │
│  │         │                              │ 暗号化: 有効         │            │ │
│  │         │                              └──────────────────────┘            │ │
│  │         │                                                                  │ │
│  │         │    ┌───────────────────────────┐                                │ │
│  │         └───>│  VPC Endpoints            │                                │ │
│  │              │  (SSM, ECR, Logs etc.)    │                                │ │
│  │              └───────────────────────────┘                                │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────┐   ┌──────────────────────────┐
│  ECR                     │   │  SSM Parameter Store     │
│  バックエンドイメージ格納    │   │  DB接続文字列 (暗号化)    │
└──────────────────────────┘   └──────────────────────────┘

┌──────────────────────────┐
│  CloudWatch Logs         │
│  ECSログ (保持: 7日)      │
└──────────────────────────┘
```

### AWS セキュリティグループ フロー図

```
CloudFront VPC Origin SG ──(HTTP:80)──> ALB SG ──(:3000)──> ECS SG ──(:5432)──> DB SG
                                                                                   ▲
                                                            Bastion SG ──(:5432)───┘
                                                               ▲
                                                          指定IPアドレス
```

---

## 3. Azure インフラ構成図

```
                                    ┌───────────┐
                                    │  ユーザー   │
                                    └─────┬─────┘
                                          │ HTTPS
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     Azure Front Door Standard                                   │
│                                                                                 │
│  ┌─────────────────────────────┐    ┌──────────────────────────────────┐        │
│  │  ルート: /*                   │    │  ルート: /api/*                   │        │
│  │  Origin Group: web          │    │  Origin Group: api              │        │
│  │  Protocol: HTTPS            │    │  Protocol: HTTPS               │        │
│  │  ヘルスプローブ: HEAD /       │    │  ヘルスプローブ: GET /health      │        │
│  └──────────────┬──────────────┘    └────────────────┬─────────────────┘        │
│                 │                                    │                          │
└─────────────────┼────────────────────────────────────┼──────────────────────────┘
                  │                                    │ ServiceTag:
                  ▼                                    │ AzureFrontDoor.Backend
┌────────────────────────────┐                         │
│  Storage Account           │                         │
│  ┌──────────────────────┐  │                         │
│  │ $web コンテナ          │  │                         │
│  │ (静的Webサイトホスティング) │  │                         │
│  │                      │  │                         │
│  │ React SPA            │  │                         │
│  │ index.html           │  │                         │
│  │ assets/              │  │                         │
│  │                      │  │                         │
│  │ エラードキュメント:      │  │                         │
│  │ index.html (SPA対応)  │  │                         │
│  └──────────────────────┘  │                         │
└────────────────────────────┘                         │
                                                       │
┌──────────────────────────────────────────────────────┼──────────────────────────┐
│  Resource Group                                      │                          │
│                                                      │                          │
│  ┌───────────────────────────────────────────────────┼────────────────────────┐ │
│  │  VNet  10.0.0.0/24                                │                        │ │
│  │                                                   │                        │ │
│  │  ┌───────────────────────────────────────────┐    │                        │ │
│  │  │  App Service Subnet 10.0.0.0/29           │    │                        │ │
│  │  │  (Delegation: Microsoft.Web/serverFarms)  │    │                        │ │
│  │  │                                           │    │                        │ │
│  │  │  ┌─────────────────────────────────┐      │    │                        │ │
│  │  │  │  App Service (Linux B1)         │ <────┼────┘                        │ │
│  │  │  │                                 │      │                             │ │
│  │  │  │  ┌───────────────────────────┐  │      │                             │ │
│  │  │  │  │  Docker Container         │  │      │                             │ │
│  │  │  │  │  (ACR → backend:latest)   │  │      │                             │ │
│  │  │  │  │                           │  │      │                             │ │
│  │  │  │  │  NestJS API (:3000)       │  │      │                             │ │
│  │  │  │  └───────────────────────────┘  │      │                             │ │
│  │  │  │                                 │      │                             │ │
│  │  │  │  IP制限:                         │      │                             │ │
│  │  │  │  ✅ AzureFrontDoor.Backend      │      │                             │ │
│  │  │  │  ❌ 0.0.0.0/0 (Deny All)       │      │                             │ │
│  │  │  │                                 │      │                             │ │
│  │  │  │  Identity: System Assigned      │      │                             │ │
│  │  │  │  (AcrPull Role)                │      │                             │ │
│  │  │  └──────────────┬──────────────────┘      │                             │ │
│  │  └─────────────────┼─────────────────────────┘                             │ │
│  │                    │ :5432                                                 │ │
│  │                    ▼                                                       │ │
│  │  ┌───────────────────────────────────────────┐                             │ │
│  │  │  DB Subnet 10.0.0.8/29                    │                             │ │
│  │  │  (Delegation: Microsoft.DBforPostgreSQL)  │                             │ │
│  │  │                                           │                             │ │
│  │  │  ┌─────────────────────────────────┐      │                             │ │
│  │  │  │  PostgreSQL Flexible Server     │      │                             │ │
│  │  │  │  v16 / B_Standard_B1ms         │      │                             │ │
│  │  │  │  Storage: 32GB                 │      │                             │ │
│  │  │  │  Public Access: ❌ 無効         │      │                             │ │
│  │  │  │  Backup: 7日保持               │      │                             │ │
│  │  │  └─────────────────────────────────┘      │                             │ │
│  │  │                                           │                             │ │
│  │  │  ┌─────────────────────────────────┐      │                             │ │
│  │  │  │  Private DNS Zone              │      │                             │ │
│  │  │  │  private.postgres.database     │      │                             │ │
│  │  │  │         .azure.com             │      │                             │ │
│  │  │  └─────────────────────────────────┘      │                             │ │
│  │  └───────────────────────────────────────────┘                             │ │
│  │                                                                            │ │
│  │  ┌───────────────────────────────────────────┐                             │ │
│  │  │  Default Subnet 10.0.0.16/28              │                             │ │
│  │  │  (Bastion等)                              │                             │ │
│  │  └───────────────────────────────────────────┘                             │ │
│  │                                                                            │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌────────────────────────────┐  ┌──────────────────────────────┐              │
│  │  Azure Container Registry │  │  Key Vault                    │              │
│  │  バックエンドイメージ格納    │  │  ・Auth0資格情報               │              │
│  │  Managed Identity: AcrPull │  │  ・DB接続文字列                │              │
│  └────────────────────────────┘  │  ・デプロイ設定                │              │
│                                  │  ・GitHub Actions OIDC設定    │              │
│  ┌────────────────────────────┐  └──────────────────────────────┘              │
│  │  Log Analytics Workspace  │                                                │
│  │  App Service診断:          │                                                │
│  │  ・ConsoleLogs            │                                                │
│  │  ・AppLogs                │                                                │
│  │  ・HTTPLogs               │                                                │
│  │  ・AllMetrics             │                                                │
│  └────────────────────────────┘                                                │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. CI/CD パイプライン構成図

### 4.1 AWS (CodePipeline)

```
┌─────────────────────────────────────────────────────────────────────┐
│                    バックエンド パイプライン                            │
│                                                                     │
│  ┌──────────┐      ┌─────────────┐      ┌────────────────┐         │
│  │ Source   │      │ Build       │      │ Deploy         │         │
│  │          │      │             │      │                │         │
│  │ GitHub   │─────>│ CodeBuild   │─────>│ ECS (Rolling)  │         │
│  │ main/**  │      │             │      │                │         │
│  │ backend/ │      │ docker build│      │ imagedefinitions│        │
│  │          │      │ ECR push    │      │ .json          │         │
│  └──────────┘      └─────────────┘      └────────────────┘         │
│     │                                                               │
│     │  トリガー: main push + backend/** パスフィルタ                   │
└─────┼───────────────────────────────────────────────────────────────┘
      │
      │  CodeStar Connection
      ▼
┌──────────┐
│ GitHub   │
│ Repo     │
└──────────┘
      ▲
      │  CodeStar Connection
      │
┌─────┼───────────────────────────────────────────────────────────────┐
│     │                                                               │
│  ┌──────────┐      ┌──────────────────────────────────┐             │
│  │ Source   │      │ Build                            │             │
│  │          │      │                                  │             │
│  │ GitHub   │─────>│ CodeBuild                        │             │
│  │ main/**  │      │                                  │             │
│  │ frontend/│      │ yarn install → yarn build        │             │
│  │          │      │ S3 upload (dist/)                │             │
│  └──────────┘      │ CloudFront cache invalidation   │             │
│                    └──────────────────────────────────┘             │
│                                                                     │
│  トリガー: main push + frontend/** パスフィルタ                       │
│                    フロントエンド パイプライン                          │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 Azure (GitHub Actions)

```
┌─────────────────────────────────────────────────────────────────────┐
│                       GitHub Actions                                │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │  deploy-backend.yaml (workflow_dispatch)                 │       │
│  │                                                          │       │
│  │  ┌──────┐   ┌──────────┐   ┌──────┐   ┌─────┐   ┌────┐ │       │
│  │  │Azure │──>│Key Vault │──>│Docker│──>│ACR  │──>│App │ │       │
│  │  │Login │   │Secrets   │   │Build │   │Push │   │Svc │ │       │
│  │  │(OIDC)│   │取得       │   │      │   │     │   │更新 │ │       │
│  │  └──────┘   └──────────┘   └──────┘   └─────┘   └────┘ │       │
│  └──────────────────────────────────────────────────────────┘       │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │  deploy-frontend.yaml (workflow_dispatch)                │       │
│  │                                                          │       │
│  │  ┌──────┐   ┌──────────┐   ┌──────┐   ┌─────┐   ┌────┐ │       │
│  │  │Azure │──>│Key Vault │──>│yarn  │──>│Blob │──>│AFD │ │       │
│  │  │Login │   │Secrets   │   │build │   │Upload│   │Purge│ │       │
│  │  │(OIDC)│   │(Auth0等)  │   │      │   │($web)│   │Cache│ │       │
│  │  └──────┘   └──────────┘   └──────┘   └─────┘   └────┘ │       │
│  └──────────────────────────────────────────────────────────┘       │
│                                                                     │
│  認証: OIDC (Federated Credentials) ── シークレット不要               │
└──────────────────────┬──────────────────────────────────────────────┘
                       │
                       ▼
            ┌─────────────────────┐
            │  Service Principal  │
            │  (Federated Cred.)  │
            │  Branch: main       │
            └─────────────────────┘
```

---

## 5. セキュリティ境界図

### AWS

```
┌─ インターネット ──────────────────────────────────────────────────┐
│                                                                  │
│   ┌──────────────┐                                               │
│   │  CloudFront  │  ← ユーザーからのHTTPSアクセス                   │
│   └──────┬───────┘                                               │
│          │                                                       │
├──────────┼── VPC境界 ────────────────────────────────────────────┤
│          │                                                       │
│   ┌──────▼───────┐    ┌───────────────┐    ┌──────────────────┐ │
│   │   ALB (内部) │───>│  ECS Fargate  │───>│ Aurora Serverless│ │
│   │ [CF VPC SG]  │    │  [ALB SG]     │    │ [ECS+Bastion SG]│ │
│   └──────────────┘    └───────────────┘    └────────▲─────────┘ │
│                                                      │          │
│                       ┌───────────────┐              │          │
│                       │   Bastion     │──────────────┘          │
│                       │  [指定IP SG]  │                          │
│                       └───────────────┘                          │
│                                                                  │
│   シークレット: SSM Parameter Store (SecureString + KMS暗号化)    │
│   イメージ: ECR (タスク実行ロールで取得)                            │
│   ログ: CloudWatch Logs                                         │
└──────────────────────────────────────────────────────────────────┘
```

### Azure

```
┌─ インターネット ──────────────────────────────────────────────────┐
│                                                                  │
│   ┌──────────────┐                                               │
│   │  Front Door  │  ← ユーザーからのHTTPSアクセス                   │
│   └──────┬───────┘                                               │
│          │ ServiceTag: AzureFrontDoor.Backend                    │
│          │                                                       │
├──────────┼── VNet境界 ───────────────────────────────────────────┤
│          │                                                       │
│   ┌──────▼───────┐                     ┌──────────────────────┐ │
│   │  App Service │────────────────────>│ PostgreSQL Flexible  │ │
│   │ [IP制限:     │   VNet統合           │ Server               │ │
│   │  FD only]    │                     │ [Public Access: OFF] │ │
│   │              │                     │ [Private DNS Zone]   │ │
│   │ Managed ID   │                     └──────────────────────┘ │
│   │ (AcrPull)    │                                               │
│   └──────────────┘                                               │
│                                                                  │
│   シークレット: Key Vault (App SettingsでKeyVault参照)             │
│   イメージ: ACR (Managed Identity AcrPullで取得)                  │
│   ログ: Log Analytics Workspace                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 6. データフロー図

```
┌─────────┐
│ブラウザ   │
└────┬────┘
     │
     │ ① HTTPS リクエスト
     ▼
┌─────────────────┐
│  CDN            │
│  CloudFront /   │
│  Front Door     │
└────┬───────┬────┘
     │       │
     │ /*    │ /api/*
     ▼       ▼
┌────────┐ ┌──────────────┐
│Frontend│ │  Backend     │
│(静的)   │ │  NestJS      │
│        │ │              │
│ React  │ │ ② JWT検証     │
│ SPA    │ │    (Auth0    │
│        │ │     JWKS)    │
└────┬───┘ │              │
     │     │ ③ Prisma ORM │
     │     │    Query     │
     │     └──────┬───────┘
     │            │
     │            ▼
     │     ┌──────────────┐
     │     │  PostgreSQL  │
     │     │  (Aurora /   │
     │     │   Flexible)  │
     │     └──────────────┘
     │
     │ ④ Auth0 ログイン
     ▼
┌─────────────┐
│   Auth0     │
│  Universal  │
│  Login      │
└─────────────┘
```

### データフロー詳細

| ステップ | 内容 | プロトコル |
|---|---|---|
| ① | ユーザーがCDNにHTTPSリクエスト送信 | HTTPS (TLS 1.2+) |
| ② | バックエンドがAuth0 JWKSエンドポイントからRS256公開鍵を取得しJWT検証 | HTTPS |
| ③ | Prisma ORMがPostgreSQLにクエリ実行 | PostgreSQL (SSL: require) |
| ④ | 未認証ユーザーがAuth0ユニバーサルログインで認証 | HTTPS (OAuth2 Authorization Code) |
